<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>{{TITLE}}</title>
    <style>
        /* ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šç¡®ä¿ body å’Œ html å æ»¡ 100% ä¸”æ— æ»šåŠ¨æ¡ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨æ¡å‡ºç° */
            background-color: {{COLOR_BG}};
            color: #fff;
            font-family: sans-serif;
        }

        /* ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šä½¿ç”¨ viewport å•ä½ç¡®ä¿ç”»å¸ƒå æ»¡å±å¹• */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }
        .header { padding: 20px; text-align: right; pointer-events: auto; }
        .social-link {
            color: rgba(255,255,255,0.6); text-decoration: none; margin-left: 15px;
            border: 1px solid rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px;
            font-size: 14px; transition: 0.3s;
        }
        .social-link:hover { background: {{COLOR_HIGHLIGHT}}; border-color: {{COLOR_HIGHLIGHT}}; color: #fff; box-shadow: 0 0 10px {{COLOR_HIGHLIGHT}}; }

        /* éŸ³ä¹æ’­æ”¾å™¨å®¹å™¨ */
        .player-container {
            pointer-events: auto;
            align-self: center;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            padding: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .footer {
            padding: 10px; text-align: center; font-size: 12px; color: rgba(255,255,255,0.3); pointer-events: auto;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }
        .footer a { color: inherit; text-decoration: none; margin: 0 10px; }

        #switch-btn {
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        #switch-btn:hover {
            background: #fff;
            color: #000;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="header">
            <button id="switch-btn" style="margin-right: 20px;">Switch Scene</button>
            <a href="{{LINK_BLOG}}" target="_blank" class="social-link">Blog</a>
            <!-- <a href="{{LINK_TWITTER}}" target="_blank" class="social-link">Twitter</a> -->
            <a href="{{LINK_GITHUB}}" target="_blank" class="social-link">GitHub</a>
        </div>

        <div class="player-container">
            {{MUSIC_IFRAME}}
        </div>

        <div class="footer">
            <a href="https://beian.miit.gov.cn/" target="_blank">{{BEIAN_ICP}}</a>
            <a href="#" target="_blank">{{BEIAN_POLICE}}</a>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { gsap } from 'https://unpkg.com/gsap@3.12.5/index.js'; // å¼•å…¥ GSAP ç”¨äºå¹³æ»‘è¿‡æ¸¡é¢œè‰²

        // --- é…ç½®å‚æ•° (ä½ å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´åŸåœºæ™¯çš„é¢œè‰²å ä½ç¬¦) ---
        const CONFIG = {
            scene1: {
                bg: '{{COLOR_BG}}', // æ›¿æ¢ä¸ºå…·ä½“é¢œè‰²ï¼Œå¦‚ #050505
                ambient: '{{COLOR_AMBIENT}}', // å¦‚ #111111
                highlight: '{{COLOR_HIGHLIGHT}}', // å¦‚ #ff0055
                cube: '{{COLOR_CUBE}}', // å¦‚ #0055ff
                fogDensity: 0.025
            },
            scene2: {
                bg: '#1a0b00', // æ·±è¤è‰²èƒŒæ™¯
                ambient: '#ffaa00', // é‡‘è‰²ç¯å¢ƒå…‰
                highlight: '#ffdd00', // æ˜äº®çš„é‡‘é»„è‰²
                cube: '#ff8800', // æ©™è‰²æ–¹å—
                fogDensity: 0.015 // è§†é‡æ›´å¼€é˜”
            }
        };

        // é»˜è®¤å›é€€é¢œè‰² (é˜²æ­¢æ¨¡æ¿å­—ç¬¦ä¸²æœªæ›¿æ¢æŠ¥é”™)
        if (CONFIG.scene1.bg.includes('{{')) CONFIG.scene1.bg = '#020205';
        if (CONFIG.scene1.ambient.includes('{{')) CONFIG.scene1.ambient = '#111111';
        if (CONFIG.scene1.highlight.includes('{{')) CONFIG.scene1.highlight = '#ff0044';
        if (CONFIG.scene1.cube.includes('{{')) CONFIG.scene1.cube = '#0044ff';

        // --- 1. åœºæ™¯åˆå§‹åŒ– ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(CONFIG.scene1.bg, CONFIG.scene1.fogDensity);
        scene.background = new THREE.Color(CONFIG.scene1.bg);

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000); // è§†è·åŠ å¤§ä»¥å®¹çº³å¤ªé˜³
        camera.position.set(0, 5, 20);

        const renderer = new THREE.WebGLRenderer({ antialias: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping; // ä½¿å¾—é«˜äº®éƒ¨åˆ†æ›´æŸ”å’Œ
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- 2. ç¯å…‰ç³»ç»Ÿ ---
        const ambientLight = new THREE.AmbientLight(CONFIG.scene1.ambient, 3.5);
        scene.add(ambientLight);

        const mainLight = new THREE.PointLight(CONFIG.scene1.highlight, 400, 100);
        mainLight.position.set(10, 10, 10);
        scene.add(mainLight);

        const auxLight = new THREE.PointLight(CONFIG.scene1.cube, 300, 100);
        auxLight.position.set(-10, -5, 10);
        scene.add(auxLight);

        // --- 3. åŸºç¡€åœºæ™¯ï¼šæ–¹å—çŸ©é˜µ (æ³¢æµª) ---
        const amount = 40; // ç¨å¾®å¢åŠ æ•°é‡è®©æµ·é¢æ›´å®½é˜”
        const count = amount * amount;
        const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        const material = new THREE.MeshStandardMaterial({
            color: CONFIG.scene1.cube,
            roughness: 0.2, // é™ä½ç²—ç³™åº¦ï¼Œæ›´åƒæ°´é¢åå…‰
            metalness: 0.9
        });
        const mesh = new THREE.InstancedMesh(geometry, material, count);

        const dummy = new THREE.Object3D();
        const offset = (amount - 1) / 2;

        // åˆå§‹åŒ–çŸ©é˜µä½ç½®
        let i = 0;
        for (let x = 0; x < amount; x++) {
            for (let z = 0; z < amount; z++) {
                dummy.position.set(offset - x, 0, offset - z);
                dummy.updateMatrix();
                mesh.setMatrixAt(i++, dummy.matrix);
            }
        }
        mesh.position.y = -5;
        scene.add(mesh);

        // --- 4. ç¬¬äºŒåœºæ™¯ä¸“å±ç‰©ä½“ï¼šé»‘æ´ç¯ä¸æ—­æ—¥ ---
        const specialGroup = new THREE.Group();
        specialGroup.visible = false; // åˆå§‹éšè—
        scene.add(specialGroup);

        // 4.1 æ—­æ—¥ (å·¨å¤§çš„å‘å…‰çƒä½“)
        const sunGeo = new THREE.SphereGeometry(12, 64, 64);
        const sunMat = new THREE.MeshBasicMaterial({ color: 0xffaa00 }); // Basicæè´¨ä¸å—å…‰ç…§å½±å“ï¼Œé…åˆBloomå‘å…‰
        const sun = new THREE.Mesh(sunGeo, sunMat);
        sun.position.set(0, 2, -40); // æ”¾åœ¨è¿œå¤„
        specialGroup.add(sun);

        // 4.2 é»‘æ´ç§¯å¸ç›˜ (å…‰ç¯) - ä½¿ç”¨åœ†ç¯å‡ ä½•ä½“
        const ringGeo = new THREE.TorusGeometry(16, 0.3, 16, 100); // åŠå¾„æ¯”å¤ªé˜³å¤§
        const ringMat = new THREE.MeshBasicMaterial({ color: 0xffccaa });
        const ring = new THREE.Mesh(ringGeo, ringMat);
        ring.position.set(0, 2, -40);
        ring.rotation.x = Math.PI / 2.5; // å€¾æ–œ
        specialGroup.add(ring);

        // 4.3 ç²’å­å…‰å°˜ (å¢åŠ ç©ºçµæ„Ÿ)
        const starGeo = new THREE.BufferGeometry();
        const starCount = 200;
        const starPos = new Float32Array(starCount * 3);
        for(let j=0; j<starCount*3; j++) {
            starPos[j] = (Math.random() - 0.5) * 60;
        }
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({color: 0xffaa00, size: 0.2, transparent: true, opacity: 0.8});
        const stars = new THREE.Points(starGeo, starMat);
        stars.position.set(0, 5, -30);
        specialGroup.add(stars);


        // --- 5. åæœŸå¤„ç† ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloomPass.threshold = 0.05;
        bloomPass.strength = 1.8;
        bloomPass.radius = 0.5;

        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- 6. åœºæ™¯åˆ‡æ¢é€»è¾‘ ---
        let isScene2 = false;
        const switchBtn = document.getElementById('switch-btn');

        switchBtn.addEventListener('click', () => {
            isScene2 = !isScene2;
            toggleScene(isScene2);
        });

        function toggleScene(toScene2) {
            const target = toScene2 ? CONFIG.scene2 : CONFIG.scene1;
            const duration = 1.5; // åŠ¨ç”»æ—¶é•¿ç§’

            // 1. é¢œè‰²å¹³æ»‘è¿‡æ¸¡ (GSAP)
            gsap.to(scene.background, { r: new THREE.Color(target.bg).r, g: new THREE.Color(target.bg).g, b: new THREE.Color(target.bg).b, duration: duration });
            gsap.to(scene.fog.color, { r: new THREE.Color(target.bg).r, g: new THREE.Color(target.bg).g, b: new THREE.Color(target.bg).b, duration: duration });
            gsap.to(scene.fog, { density: target.fogDensity, duration: duration });

            // ç¯å…‰é¢œè‰²è¿‡æ¸¡
            gsap.to(ambientLight.color, { r: new THREE.Color(target.ambient).r, g: new THREE.Color(target.ambient).g, b: new THREE.Color(target.ambient).b, duration: duration });
            gsap.to(mainLight.color, { r: new THREE.Color(target.highlight).r, g: new THREE.Color(target.highlight).g, b: new THREE.Color(target.highlight).b, duration: duration });
            gsap.to(auxLight.color, { r: new THREE.Color(target.cube).r, g: new THREE.Color(target.cube).g, b: new THREE.Color(target.cube).b, duration: duration });

            // æ–¹å—æè´¨é¢œè‰²è¿‡æ¸¡
            gsap.to(material.color, { r: new THREE.Color(target.cube).r, g: new THREE.Color(target.cube).g, b: new THREE.Color(target.cube).b, duration: duration });

            // 2. ç‰©ä½“æ˜¾éšæ§åˆ¶
            if (toScene2) {
                specialGroup.visible = true;
                // æ—­æ—¥å‡èµ·åŠ¨ç”»
                gsap.fromTo(sun.position, { y: -10 }, { y: 2, duration: 3, ease: "power2.out" });
                gsap.to(bloomPass, { strength: 2.5, duration: 1 }); // å¢å¼ºå…‰æ•ˆ
            } else {
                // éšè—å›é€€
                gsap.to(sun.position, { y: -20, duration: 1, onComplete: () => { specialGroup.visible = false; } });
                gsap.to(bloomPass, { strength: 1.8, duration: 1 });
            }
        }

        // --- 7. åŠ¨ç”»å¾ªç¯ ---
        const timeScale = 0.002;

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * timeScale;

            // çŸ©é˜µæ³¢æµªåŠ¨ç”»
            let i = 0;
            for (let x = 0; x < amount; x++) {
                for (let z = 0; z < amount; z++) {
                    // ä¸¤ç§æ¨¡å¼ä¸‹æ³¢æµªç¨å¾®ä¸åŒï¼ŒScene2å¯ä»¥è®©æ³¢æµªæ›´å¹³ç¼“ä¸€äº›
                    const waveScale = isScene2 ? 1.0 : 2.0;
                    let y = Math.sin(x * 0.5 + time) * Math.cos(z * 0.5 + time) * waveScale;
                    y += Math.sin(x * 0.2 + time * 2) * (isScene2 ? 0.5 : 1.5);

                    dummy.position.set(offset - x, y, offset - z);

                    // æ—‹è½¬æ•ˆæœ
                    dummy.rotation.x = time * 0.5 + x * 0.1;
                    dummy.rotation.z = time * 0.5 + z * 0.1;

                    dummy.updateMatrix();
                    mesh.setMatrixAt(i++, dummy.matrix);
                }
            }
            mesh.instanceMatrix.needsUpdate = true;

            // ç¯å…‰å‘¼å¸
            mainLight.intensity = 400 + Math.sin(time * 5) * 100;

            // æ‘„åƒæœºç§»åŠ¨ (Scene2 æ—¶è®©æ‘„åƒæœºç§»åŠ¨æ›´å¹³ç¼“ï¼Œèšç„¦äºä¸­å¿ƒ)
            const camTime = Date.now() * 0.0001;
            if (!isScene2) {
                camera.position.x = Math.sin(camTime) * 18;
                camera.position.z = Math.cos(camTime) * 18;
                camera.lookAt(0, 0, 0);
            } else {
                // æ—­æ—¥æ¨¡å¼ä¸‹ï¼Œæ‘„åƒæœºç¼“æ…¢æ­£å¯¹å¤ªé˜³
                camera.position.x = Math.sin(camTime * 0.5) * 5;
                camera.position.z = 25 + Math.cos(camTime * 0.5) * 2;
                camera.lookAt(0, 2, -40); // çœ‹å‘å¤ªé˜³
            }

            // ç‰¹æ®Šç‰©ä½“åŠ¨ç”» (é»‘æ´ç¯æ—‹è½¬)
            if (specialGroup.visible) {
                ring.rotation.z -= 0.005; // ç¯è‡ªè½¬
                ring.rotation.x = Math.PI / 2.5 + Math.sin(time) * 0.05; // ç¯å¾®å¹…æ‘†åŠ¨
                stars.rotation.y = time * 0.05; // æ˜Ÿæ˜Ÿæ—‹è½¬
            }

            composer.render();
        }

        animate();

        // çª—å£å°ºå¯¸ç›‘å¬
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- favicon -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <title>{{TITLE}}</title>
    <style>
        /* ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šç¡®ä¿ body å’Œ html å æ»¡ 100% ä¸”æ— æ»šåŠ¨æ¡ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨æ¡å‡ºç° */
            background-color: {{COLOR_BG}};
            color: #fff;
            font-family: sans-serif;
        }

        /* ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šä½¿ç”¨ viewport å•ä½ç¡®ä¿ç”»å¸ƒå æ»¡å±å¹• */
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }

        /* UI å±‚ */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }
        .header { padding: 20px; text-align: right; pointer-events: auto; }
        .social-link {
            color: rgba(255,255,255,0.6); text-decoration: none; margin-left: 15px;
            border: 1px solid rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px;
            font-size: 14px; transition: 0.3s;
        }
        .social-link:hover { background: {{COLOR_HIGHLIGHT}}; border-color: {{COLOR_HIGHLIGHT}}; color: #fff; box-shadow: 0 0 10px {{COLOR_HIGHLIGHT}}; }

        /* éŸ³ä¹æ’­æ”¾å™¨å®¹å™¨ */
        .player-container {
            pointer-events: auto;
            align-self: center;
            margin-bottom: 20px;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
            border-radius: 8px;
            padding: 5px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .footer {
            padding: 10px; text-align: center; font-size: 12px; color: rgba(255,255,255,0.3); pointer-events: auto;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }
        .footer a { color: inherit; text-decoration: none; margin: 0 10px; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div class="header">
            <a href="{{LINK_BLOG}}" target="_blank" class="social-link">Blog</a>
            <!-- <a href="{{LINK_TWITTER}}" target="_blank" class="social-link">Twitter</a> -->
            <a href="{{LINK_GITHUB}}" target="_blank" class="social-link">GitHub</a>
        </div>

        <div class="player-container">
            {{MUSIC_IFRAME}}
        </div>

        <div class="footer">
            <a href="https://beian.miit.gov.cn/" target="_blank">{{BEIAN_ICP}}</a>
            <a href="#" target="_blank">{{BEIAN_POLICE}}</a>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- 1. åœºæ™¯ ---
        const scene = new THREE.Scene();
        // ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šå‡å¼±é›¾æ°”å¯†åº¦ï¼Œè®©è¿œå¤„çš„ç‰©ä½“æ›´æ¸…æ™°å˜äº®
        scene.fog = new THREE.FogExp2('{{COLOR_BG}}', 0.025);
        scene.background = new THREE.Color('{{COLOR_BG}}');

        const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 5, 20);
        camera.lookAt(0, 0, 0);

        const renderer = new THREE.WebGLRenderer({ antialias: false });
        // ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šç¡®ä¿åˆå§‹åŒ–æ—¶å°±æ˜¯å…¨å±å°ºå¯¸
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // --- 2. ç¯å…‰ (ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šå¤§å¹…æé«˜äº®åº¦) ---

        // æé«˜ç¯å¢ƒå…‰ï¼Œç…§äº®æš—éƒ¨ (åŸ 2.0 -> ç° 3.5)
        const ambientLight = new THREE.AmbientLight('{{COLOR_AMBIENT}}', 3.5);
        scene.add(ambientLight);

        // æé«˜çº¢è‰²ä¸»å…‰æºå¼ºåº¦ (åŸ 150 -> ç° 400)
        const redLight = new THREE.PointLight('{{COLOR_HIGHLIGHT}}', 400, 50);
        redLight.position.set(10, 5, 10);
        scene.add(redLight);

        // æé«˜è“è‰²è¾…åŠ©å…‰æºå¼ºåº¦ (åŸ 100 -> ç° 300)
        const blueLight = new THREE.PointLight('{{COLOR_CUBE}}', 300, 50);
        blueLight.position.set(-10, -5, 10);
        scene.add(blueLight);

        // --- 3. ç«‹æ–¹ä½“çŸ©é˜µ ---
        const amount = 30;
        const count = amount * amount;
        const geometry = new THREE.BoxGeometry(0.8, 0.8, 0.8);
        // æè´¨ä¿æŒä¸å˜ï¼Œä¾é æ›´å¼ºçš„ç¯å…‰æ¥ç…§äº®å®ƒ
        const material = new THREE.MeshStandardMaterial({
            color: '{{COLOR_CUBE}}', roughness: 0.4, metalness: 0.8
        });
        const mesh = new THREE.InstancedMesh(geometry, material, count);

        const dummy = new THREE.Object3D();
        let i = 0;
        const offset = (amount - 1) / 2;

        for (let x = 0; x < amount; x++) {
            for (let z = 0; z < amount; z++) {
                dummy.position.set(offset - x, 0, offset - z);
                dummy.updateMatrix();
                mesh.setMatrixAt(i++, dummy.matrix);
            }
        }
        mesh.position.y = -5;
        scene.add(mesh);

        // --- 4. Bloom å‘å…‰åæœŸ (ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šå¢å¼ºå‘å…‰æ„Ÿ) ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        // é™ä½é˜ˆå€¼ï¼Œè®©æ›´å¤šåŸæœ¬ç¨æš—çš„åœ°æ–¹ä¹Ÿå¼€å§‹å‘å…‰ (åŸ 0.1 -> ç° 0.05)
        bloomPass.threshold = 0.05;
        // æé«˜å¼ºåº¦ (åŸ 1.0 -> ç° 1.8)
        bloomPass.strength = 1.8;
        bloomPass.radius = 0.5;

        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- 5. åŠ¨ç”»å¾ªç¯ ---
        const timeScale = 0.002;

        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * timeScale;

            let i = 0;
            for (let x = 0; x < amount; x++) {
                for (let z = 0; z < amount; z++) {
                    let y = Math.sin(x * 0.5 + time) * Math.cos(z * 0.5 + time) * 2;
                    y += Math.sin(x * 0.2 + time * 2) * 1.5;

                    dummy.position.set(offset - x, y, offset - z);
                    dummy.rotation.x = time * 0.5 + x * 0.1;
                    dummy.rotation.z = time * 0.5 + z * 0.1;

                    dummy.updateMatrix();
                    mesh.setMatrixAt(i++, dummy.matrix);
                }
            }
            mesh.instanceMatrix.needsUpdate = true;

            // å‘¼å¸ç¯æ•ˆæœä¹ŸéšåŸºç¡€äº®åº¦æé«˜ (åŸ 150åŸºæ•° -> ç° 400åŸºæ•°)
            redLight.intensity = 400 + Math.sin(time * 5) * 100;

            const camTime = Date.now() * 0.0001;
            camera.position.x = Math.sin(camTime) * 18;
            camera.position.z = Math.cos(camTime) * 18;
            camera.lookAt(0, 0, 0);

            composer.render();
        }

        animate();

        // --- ğŸ” é‡ç‚¹ä¿®æ”¹ï¼šçª—å£å°ºå¯¸å˜åŒ–ç›‘å¬ ---
        window.addEventListener('resize', () => {
            // 1. æ›´æ–°æ‘„åƒæœºé•¿å®½æ¯”
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            // 2. æ›´æ–°æ¸²æŸ“å™¨å°ºå¯¸
            renderer.setSize(window.innerWidth, window.innerHeight);

            // 3. é‡è¦ï¼šåŒæ—¶æ›´æ–°åæœŸå¤„ç†åˆæˆå™¨çš„å°ºå¯¸ï¼Œå¦åˆ™ç”»é¢ä¼šæ‹‰ä¼¸å˜å½¢
            composer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
